# Модель веток и релизы

## Ветки

| Ветка | Назначение |
|-------|------------|
| **main** | Продакшен. Содержит только проверенный код, готовый к релизу. Обновляется слиянием из `develop` или hotfix-веток. |
| **develop** | Интеграционная ветка. Сюда мержатся фичи и исправления. CI (тесты, линтеры) запускается при push и при PR. |

Другие ветки создаются от `develop` (или от `main` для hotfix), например:
- `feature/experiment-export` — новая фича
- `fix/auth-redirect` — исправление бага
- `release/1.1.0` — подготовка релиза (опционально)
- `hotfix/critical-fix` — срочный фикс в прод (от `main`)

## Жизненный цикл

1. Разработка ведётся в ветках от `develop`.
2. Готовый код попадает в `develop` через Pull Request (после прохождения CI).
3. Когда накопленные изменения готовы к выпуску:
   - при необходимости создаётся ветка `release/X.Y.Z` от `develop` для финальных правок;
   - после стабилизации `develop` (или `release/X.Y.Z`) сливается в `main`.
4. Релиз создаётся **тегом** на `main`: `vX.Y.Z` (например `v1.0.0`).
5. Пуш тега `v*` запускает в CI: сборку образов, пуш в Container Registry, деплой на Yandex Cloud и создание GitHub Release.

## Релизы

- Версии задаются тегами в формате **семантического версионирования**: `v1.0.0`, `v1.1.0`, `v2.0.0`.
- Сборка и деплой в Yandex Cloud выполняются **только при пуше тега** `v*`, а не при каждом push в `main`.
- Образы в реестре тегируются версией (например `auth-service:v1.0.0`) и `latest` для последнего релиза.
- На VM в `.env` выставляется `IMAGE_TAG=v1.0.0` для данного релиза.

## Первый релиз (v1.0.0)

1. Если ветки `develop` ещё нет: создать от текущего `main` и запушить:
   ```bash
   git checkout main && git pull origin main
   git checkout -b develop && git push -u origin develop
   ```
   Дальнейшую разработку вести в `develop` (мержить фичи в неё).
2. Убедиться, что `develop` актуальна и CI зелёный. Слить `develop` в `main` (через PR или локально и push).
3. На коммите в `main` создать тег и запушить:
   ```bash
   git checkout main
   git pull origin main
   git tag -a v1.0.0 -m "Release v1.0.0"
   git push origin v1.0.0
   ```
4. В GitHub Actions запустится workflow «Release (Build & Deploy)»: тесты → сборка образов → пуш в CR → деплой на VM → создание GitHub Release.
5. После успешного прохождения проверить приложение на VM (см. [deployment-yandex-cloud.md](deployment-yandex-cloud.md)).

## Hotfix (срочный фикс в прод)

1. Создать ветку от `main`: `git checkout main && git pull && git checkout -b hotfix/описание`.
2. Внести исправления, прогнать тесты локально.
3. Открыть PR в `main`, после мержа создать тег (например `v1.0.1`) и push тега — пойдёт сборка и деплой.
4. Слить `main` обратно в `develop`, чтобы не потерять фикс: `git checkout develop && git merge main`.
