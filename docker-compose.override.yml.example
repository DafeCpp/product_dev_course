# Docker Compose Override для Development режима
#
# Использование:
# 1. Скопируйте этот файл: cp docker-compose.override.yml.example docker-compose.override.yml
# 2. docker-compose автоматически загрузит этот файл при запуске
# 3. Для production используйте: docker-compose -f docker-compose.yml up (без override)
#
# Этот файл переопределяет настройки из основного docker-compose.yml для:
# - Hot-reload через volumes
# - Dev команды запуска
# - Dev stages из Dockerfile'ов
# - Дополнительные порты для отладки

version: "3.9"

services:
  # Experiment Service - Backend
  experiment-service:
    # Монтируем исходный код для hot-reload
    volumes:
      - ./backend/services/experiment-service/src:/app/src:ro
      # Исключаем кэш Python для избежания конфликтов
      - /app/src/__pycache__
    # Используем watchfiles для автоматической перезагрузки при изменении кода
    command: >
      sh -c "
        if command -v watchfiles >/dev/null 2>&1; then
          watchfiles 'python -m experiment_service.main' --filter python ./src
        else
          python -m experiment_service.main
        fi
      "
    environment:
      - DEV_MODE=true
      - ENV=development
    # Дополнительные порты для отладки (если нужны)
    # ports:
    #   - "8002:8002"  # уже определено в основном compose

  # Auth Proxy - BFF
  auth-proxy:
    # Используем development stage из Dockerfile
    build:
      context: ./frontend/apps/auth-proxy
      dockerfile: Dockerfile
      target: development
    # Монтируем исходный код для hot-reload
    volumes:
      - ./frontend/apps/auth-proxy/src:/app/src
      - ./frontend/apps/auth-proxy/tsconfig.json:/app/tsconfig.json
      # Исключаем node_modules и dist для избежания конфликтов
      - /app/node_modules
      - /app/dist
    # Используем dev команду (ts-node-dev с hot-reload)
    command: npm run dev
    environment:
      - NODE_ENV=development
      - DEV_MODE=true
    # Порты уже определены в основном compose

  # Experiment Portal - Frontend
  experiment-portal:
    # Используем development stage из Dockerfile
    build:
      context: ./frontend/apps/experiment-portal
      dockerfile: Dockerfile
      target: development
    # Монтируем исходный код для hot-reload
    volumes:
      - ./frontend/apps/experiment-portal/src:/app/src
      - ./frontend/apps/experiment-portal/index.html:/app/index.html
      - ./frontend/apps/experiment-portal/vite.config.ts:/app/vite.config.ts
      - ./frontend/apps/experiment-portal/tsconfig.json:/app/tsconfig.json
      - ./frontend/apps/experiment-portal/tsconfig.node.json:/app/tsconfig.node.json
      # Исключаем node_modules и dist
      - /app/node_modules
      - /app/dist
    # Используем Vite dev server с hot-reload
    command: npm run dev
    environment:
      - NODE_ENV=development
      - DEV_MODE=true
    # Vite dev server использует порт 3000
    ports:
      - "3000:3000"

  # PostgreSQL - открываем порт для локального доступа
  postgres:
    ports:
      - "5433:5432"  # Доступ к БД с хоста для отладки и миграций (5433 чтобы не конфликтовать с локальным PostgreSQL)

  # Redis (если используется)
  # redis:
  #   ports:
  #     - "6379:6379"  # Доступ к Redis с хоста

  # RabbitMQ (если используется)
  # rabbitmq:
  #   ports:
  #     - "5672:5672"      # AMQP порт
  #     - "15672:15672"    # Management UI

