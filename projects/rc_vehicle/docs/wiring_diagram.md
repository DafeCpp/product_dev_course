# Схема подключения RC Vehicle

## Общая архитектура

```
┌─────────────┐         UART            ┌─────────────┐
│   ESP32-S3  │◄───────────────────────►│    RP2040   │
│  (Wi-Fi AP) │  115200 baud            │ (Controller)│
└─────────────┘                         └─────────────┘
      │                                        │
      │                                        ├──► PWM GPIO2 ──► ESC (Throttle)
      │                                        ├──► PWM GPIO3 ──► Servo (Steering)
      │                                        ├──► GPIO4 ──► RC Receiver CH1 (Throttle)
      │                                        ├──► GPIO5 ──► RC Receiver CH2 (Steering)
      │                                        ├──► I2C GPIO6/7 ──► MPU-6050 (IMU)
      │                                        │
      └──► Wi-Fi AP (для веб-интерфейса)
```

## Детальная схема подключений

### 1. ESP32-S3 Zero mini

**Питание:**
- `5V` → от BEC 5V (через стабилизатор на плате ESP32-S3)
- `GND` → общая земля

**UART к RP2040:**
- `GPIO17 (TX)` → `GPIO1 (RX)` на RP2040
- `GPIO18 (RX)` → `GPIO0 (TX)` на RP2040
- `GND` → общая земля

**Примечание:** ESP32-S3 Zero mini имеет встроенный стабилизатор 3.3V, питается от 5V.

### 2. Raspberry Pi Pico (RP2040)

**Питание:**
- `VSYS` или `VBUS` → 5V от BEC (через стабилизатор на плате Pico)
- `GND` → общая земля
- `3V3` → выход стабилизатора (для внешних компонентов)

**UART к ESP32:**
- `GPIO0 (UART0 TX)` → `GPIO18 (RX)` на ESP32-S3
- `GPIO1 (UART0 RX)` → `GPIO17 (TX)` на ESP32-S3
- `GND` → общая земля

**PWM выходы (50 Hz, 1-2 мс):**
- `GPIO2 (PWM)` → Signal вход ESC (Throttle)
- `GPIO3 (PWM)` → Signal вход Servo (Steering)
- `GND` → общая земля с ESC/Servo

**RC-in входы (чтение PWM с приёмника):**
- `GPIO4` → Signal канал CH1 (Throttle) с RC приёмника
- `GPIO5` → Signal канал CH2 (Steering) с RC приёмника
- `GND` → общая земля с RC приёмником

**⚠️ ВАЖНО:** Если RC приёмник выдаёт 5V логику, используйте делители напряжения:
- Резистор 10kΩ между Signal и GPIO
- Резистор 20kΩ между GPIO и GND
- Или используйте level-shifter 5V→3.3V

**I2C к MPU-6050:**
- `GPIO6 (SDA)` → SDA на MPU-6050
- `GPIO7 (SCL)` → SCL на MPU-6050
- `3V3` → VCC на MPU-6050
- `GND` → GND на MPU-6050

**Подтягивающие резисторы:**
- I2C требует подтягивающие резисторы 4.7kΩ на SDA и SCL к 3.3V
- ⚠️ **Проверка**: Большинство готовых breakout-модулей MPU-6050/MPU-9250 **уже имеют встроенные подтягивающие резисторы**
- **Как проверить**:
  * Визуально: найдите мелкие SMD-резисторы рядом с линиями SCL/SDA (обычно между SCL/SDA и VCC)
  * Мультиметром: измерьте сопротивление между SCL и VCC, затем SDA и VCC (должно быть 2.2–10 кОм)
- **Рекомендация**: Сначала попробуйте подключить без дополнительных резисторов. Если I2C не работает, добавьте внешние резисторы 4.7kΩ между SDA/SCL и 3.3V

### 3. MPU-6050 (IMU)

**Подключение:**
- `VCC` → 3.3V от RP2040
- `GND` → GND
- `SDA` → GPIO6 (SDA) на RP2040
- `SCL` → GPIO7 (SCL) на RP2040
- `AD0` → GND (адрес I2C: 0x68) или 3.3V (адрес: 0x69)

**Примечание:** Проверьте адрес I2C в `config.hpp` (по умолчанию 0x68).

### 4. RC Приёмник (Himoto 2.4GHz 4CH)

**Подключение:**
- `CH1 (Signal)` → GPIO4 на RP2040 (через делитель, если 5V)
- `CH2 (Signal)` → GPIO5 на RP2040 (через делитель, если 5V)
- `+` → 5V от BEC (если требуется питание приёмника)
- `-` → GND

**Примечание:** RC приёмник обычно питается от BEC или батареи отдельно.

### 5. ESC (Electronic Speed Controller)

**Подключение:**
- `Signal` → GPIO2 (PWM) на RP2040
- `+` → 5V (обычно не используется, ESC питается от батареи)
- `-` → GND

**Примечание:** ESC питается напрямую от батареи (обычно 2S LiPo, 7.4V).

### 6. Servo (Рулевой сервопривод)

**Подключение:**
- `Signal` → GPIO3 (PWM) на RP2040
- `+` → 5V от BEC
- `-` → GND

### 7. Питание (BEC)

**Подключение:**
- `Input` → Батарея 2S LiPo (7.4V)
- `Output 5V` →
  - ESP32-S3 (5V)
  - RP2040 (VSYS/VBUS)
  - Servo (+)
  - RC приёмник (если требуется)
- `GND` → общая земля всех компонентов

**Конденсаторы для стабилизации:**
- 470-1000µF электролитический на шине 5V
- 0.1µF керамический параллельно

## Таблица подключений (краткая)

| Компонент | Контакт | RP2040/ESP32 | Примечание |
|-----------|---------|--------------|------------|
| ESP32-S3 | GPIO17 (TX) | RP2040 GPIO1 (RX) | UART |
| ESP32-S3 | GPIO18 (RX) | RP2040 GPIO0 (TX) | UART |
| ESC | Signal | RP2040 GPIO2 | PWM, 50Hz |
| Servo | Signal | RP2040 GPIO3 | PWM, 50Hz |
| RC RX | CH1 | RP2040 GPIO4 | Через делитель если 5V |
| RC RX | CH2 | RP2040 GPIO5 | Через делитель если 5V |
| MPU-6050 | SDA | RP2040 GPIO6 | I2C, 400kHz |
| MPU-6050 | SCL | RP2040 GPIO7 | I2C, 400kHz |
| MPU-6050 | VCC | RP2040 3V3 | Питание |
| Все | GND | Общая земля | ⚠️ Важно! |

## Делитель напряжения для RC-in (если нужно)

Если RC приёмник выдаёт 5V логику, а RP2040 работает на 3.3V:

```
RC Signal (5V) ──[10kΩ]──┬── GPIO4/GPIO5 (3.3V max)
                          │
                         [20kΩ]
                          │
                         GND
```

Формула: Vout = Vin × R2/(R1+R2) = 5V × 20k/(10k+20k) = 3.33V ✓

## Порядок подключения (рекомендуемый)

1. **Питание:**
   - Подключить BEC к батарее
   - Проверить выход 5V мультиметром
   - Подключить конденсаторы на шину 5V

2. **Микроконтроллеры:**
   - Подключить ESP32-S3 к 5V и GND
   - Подключить RP2040 к 5V и GND
   - Проверить, что оба работают (LED индикация)

3. **UART связь:**
   - Подключить TX→RX между ESP32 и RP2040
   - Подключить общую землю

4. **IMU:**
   - Подключить MPU-6050 к I2C (GPIO6/7)
   - Подключить питание 3.3V

5. **RC приёмник:**
   - Подключить сигналы через делители (если нужно)
   - Подключить питание (если требуется)

6. **Исполнительные устройства:**
   - Подключить ESC к GPIO2
   - Подключить Servo к GPIO3
   - ⚠️ Безопасность: убедитесь, что failsafe работает перед тестами!

## Проверка подключений

1. **Питание:**
   - Проверить 5V на всех точках питания
   - Проверить 3.3V на RP2040 и MPU-6050

2. **UART:**
   - Проверить связь между ESP32 и RP2040 (логи в Serial Monitor)

3. **I2C:**
   - Проверить адрес MPU-6050 (должен быть 0x68 или 0x69)

4. **PWM:**
   - Проверить осциллографом сигналы на GPIO2/GPIO3
   - Должны быть импульсы 1-2 мс, частота 50 Hz

5. **RC-in:**
   - Проверить сигналы с приёмника на GPIO4/GPIO5

## Безопасность

⚠️ **ВАЖНО:**
- Всегда проверяйте failsafe перед первым запуском
- Убедитесь, что при потере связи ESC получает нейтральный сигнал
- Используйте предохранители на линиях питания
- Не подключайте/отключайте компоненты при включенном питании
- Проверяйте полярность батареи перед подключением

