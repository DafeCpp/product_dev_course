# Схема подключения RC Vehicle

## Варианты архитектур

В проекте используются три варианта аппаратных платформ:

| Вариант | Платы | Назначение |
|---------|-------|------------|
| **ESP32-S3 N16R8** | Одна плата | Целевая платформа (dual-core, FPU, PSRAM) |
| **ESP32-C6** | Одна плата | Прототипирование Фазы 0 (single-core, FPU) |
| ESP32-C3 + RP2040 | Две платы | Legacy (оставлена для справки) |

---

## Архитектура: ESP32-S3 N16R8 (целевая)

Единая плата — Wi-Fi, control loop, IMU, PWM на одном чипе. Нет UART-моста.

```
┌──────────────────────────────────────────────────────┐
│                   ESP32-S3 N16R8                     │
│              (Dual Xtensa LX7 @ 240 МГц)            │
│                                                      │
│  Core 0: Wi-Fi AP + WebSocket                        │
│  Core 1: Control Loop (IMU + фильтрация + PID + PWM)│
│                                                      │
│  SPI2 ──► MPU-6500 (IMU)                             │
│  MCPWM0 ──► ESC (Throttle)                           │
│  MCPWM0 ──► Servo (Steering)                         │
│  GPIO ──► RC Receiver CH1 (Throttle)                 │
│  GPIO ──► RC Receiver CH2 (Steering)                 │
└──────────────────────────────────────────────────────┘
```

### Распиновка ESP32-S3 N16R8

**⚠️ N16R8 (Octal Flash + Octal PSRAM):** GPIO26–37 заняты Flash/PSRAM — **не использовать!**

**Питание:**
- `5V` → от BEC 5V (через USB-разъём или пин 5V на плате)
- `GND` → общая земля

**SPI2 к MPU-6500 (IMU):**

| ESP32-S3     | MPU-6500          | Надпись на плате   | Назначение        |
|--------------|-------------------|--------------------|-------------------|
| GPIO10 (CS)  | NCS / CS          | **NCS**            | Chip Select       |
| GPIO12 (SCK) | SCLK              | **SCL / SCLK**     | Тактирование SPI  |
| GPIO11 (MOSI)| MOSI              | **SDA / SDI**      | Данные к датчику  |
| GPIO13 (MISO)| MISO              | **ADO / SDO**      | Данные от датчика |
| 3V3          | VCC               | **VCC**            | Питание 3.3 V     |
| GND          | GND               | **GND**            | Земля             |

**MCPWM выходы (50 Hz, 1-2 мс):**
- `GPIO14 (MCPWM0)` → Signal вход ESC (Throttle)
- `GPIO21 (MCPWM0)` → Signal вход Servo (Steering)
- `GND` → общая земля с ESC/Servo

**RC-in входы (чтение PWM с приёмника):**
- `GPIO16` → Signal канал CH1 (Throttle) с RC приёмника
- `GPIO17` → Signal канал CH2 (Steering) с RC приёмника
- `GND` → общая земля с RC приёмником

**⚠️ ВАЖНО:** Если RC приёмник выдаёт 5V логику, используйте делители напряжения (см. раздел ниже).

### Таблица подключений ESP32-S3

| Компонент         | Контакт   | ESP32-S3 GPIO | Примечание             |
|-------------------|-----------|---------------|------------------------|
| MPU-6500          | NCS       | GPIO10        | SPI2 CS                |
| MPU-6500          | SCLK      | GPIO12        | SPI2 SCK               |
| MPU-6500          | MOSI      | GPIO11        | SPI2 MOSI              |
| MPU-6500          | MISO      | GPIO13        | SPI2 MISO              |
| MPU-6500          | VCC       | 3V3           | Питание                |
| ESC               | Signal    | GPIO14        | MCPWM0, 50Hz           |
| Servo             | Signal    | GPIO21        | MCPWM0, 50Hz           |
| RC RX             | CH1       | GPIO16        | Через делитель если 5V |
| RC RX             | CH2       | GPIO17        | Через делитель если 5V |
| Все               | GND       | Общая земля   | ⚠️ Важно!              |

### Свободные GPIO ESP32-S3 (для расширения)

| GPIO         | Статус                                    |
|--------------|-------------------------------------------|
| GPIO1–9      | Свободны                                  |
| GPIO15, GPIO18 | Свободны                                |
| GPIO38–48    | Свободны (GPIO48 — встроенный RGB LED)    |
| GPIO19, GPIO20 | USB D-/D+ (не использовать если USB нужен) |
| GPIO26–37    | ⛔ Flash/PSRAM (N16R8) — не использовать  |
| GPIO0, GPIO3, GPIO45, GPIO46 | Strapping — можно после загрузки |

---

## Архитектура: ESP32-C6 (прототипирование)

Единая плата для прототипирования Фазы 0. Один RISC-V core @ 160 МГц (+ LP-core 20 МГц), FPU есть.

```
┌──────────────────────────────────────────────────────┐
│                     ESP32-C6                         │
│              (RISC-V @ 160 МГц, FPU)                 │
│                                                      │
│  Single core: Wi-Fi + Control Loop                   │
│  (разделение по приоритетам FreeRTOS)                │
│                                                      │
│  SPI2 ──► MPU-6500 (IMU)                             │
│  MCPWM ──► ESC (Throttle)                            │
│  MCPWM ──► Servo (Steering)                          │
│  GPIO ──► RC Receiver CH1 (Throttle)                 │
│  GPIO ──► RC Receiver CH2 (Steering)                 │
└──────────────────────────────────────────────────────┘
```

### Распиновка ESP32-C6

**⚠️ ESP32-C6:** GPIO12–13 заняты USB — **не использовать!** GPIO24–30 — внутренний SPI Flash — **не использовать!**

**Питание:**
- `5V` → от BEC 5V (через USB-разъём или пин 5V на плате)
- `GND` → общая земля

**SPI2 к MPU-6500 (IMU):**

| ESP32-C6     | MPU-6500          | Надпись на плате   | Назначение        |
|--------------|-------------------|--------------------|-------------------|
| GPIO10 (CS)  | NCS / CS          | **NCS**            | Chip Select       |
| GPIO6 (SCK)  | SCLK              | **SCL / SCLK**     | Тактирование SPI  |
| GPIO7 (MOSI) | MOSI              | **SDA / SDI**      | Данные к датчику  |
| GPIO2 (MISO) | MISO              | **ADO / SDO**      | Данные от датчика |
| 3V3          | VCC               | **VCC**            | Питание 3.3 V     |
| GND          | GND               | **GND**            | Земля             |

**MCPWM выходы (50 Hz, 1-2 мс):**
- `GPIO3 (MCPWM)` → Signal вход ESC (Throttle)
- `GPIO4 (MCPWM)` → Signal вход Servo (Steering)
- `GND` → общая земля с ESC/Servo

**RC-in входы (чтение PWM с приёмника):**
- `GPIO5` → Signal канал CH1 (Throttle) с RC приёмника
- `GPIO11` → Signal канал CH2 (Steering) с RC приёмника
- `GND` → общая земля с RC приёмником

**⚠️ ВАЖНО:** Если RC приёмник выдаёт 5V логику, используйте делители напряжения (см. раздел ниже).

### Таблица подключений ESP32-C6

| Компонент         | Контакт   | ESP32-C6 GPIO | Примечание             |
|-------------------|-----------|---------------|------------------------|
| MPU-6500          | NCS       | GPIO10        | SPI2 CS                |
| MPU-6500          | SCLK      | GPIO6         | SPI2 SCK               |
| MPU-6500          | MOSI      | GPIO7         | SPI2 MOSI              |
| MPU-6500          | MISO      | GPIO2         | SPI2 MISO              |
| MPU-6500          | VCC       | 3V3           | Питание                |
| ESC               | Signal    | GPIO3         | MCPWM, 50Hz            |
| Servo             | Signal    | GPIO4         | MCPWM, 50Hz            |
| RC RX             | CH1       | GPIO5         | Через делитель если 5V |
| RC RX             | CH2       | GPIO11        | Через делитель если 5V |
| Все               | GND       | Общая земля   | ⚠️ Важно!              |

### Свободные GPIO ESP32-C6 (для расширения)

| GPIO         | Статус                                    |
|--------------|-------------------------------------------|
| GPIO0, GPIO1 | Свободны                                 |
| GPIO14       | Свободен                                  |
| GPIO18–23    | Свободны                                  |
| GPIO8        | Встроенный LED на многих платах; strapping — можно после загрузки |
| GPIO9, GPIO15 | Strapping — можно после загрузки         |
| GPIO12, GPIO13 | ⛔ USB D-/D+ — не использовать          |
| GPIO24–30   | ⛔ SPI Flash — не использовать            |

---

## Переносимость кода между ESP32-C6 и ESP32-S3

Пины вынесены в конфигурацию (`config.hpp` / `Kconfig`). При смене платформы меняется только target и pin map:

```
idf.py set-target esp32s3   # или esp32c6
```

| Функция       | ESP32-C6 | ESP32-S3 | Отличие в коде           |
|---------------|----------|----------|--------------------------|
| SPI CS        | GPIO10   | GPIO10   | Одинаковый               |
| SPI SCK       | GPIO6    | GPIO12   | Только pin config        |
| SPI MOSI      | GPIO7    | GPIO11   | Только pin config        |
| SPI MISO      | GPIO2    | GPIO13   | Только pin config        |
| MCPWM ESC     | GPIO3    | GPIO14   | Только pin config        |
| MCPWM Servo   | GPIO4    | GPIO21   | Только pin config        |
| RC-in CH1     | GPIO5    | GPIO16   | Только pin config        |
| RC-in CH2     | GPIO11   | GPIO17   | Только pin config        |
| Core pinning  | —        | Core 1   | `xTaskCreatePinnedToCore` |

---

## Архитектура: ESP32-C3 + RP2040 (legacy)

> **Примечание:** Эта архитектура оставлена для справки. Текущая разработка ведётся на ESP32-S3 / ESP32-C6 (standalone).

```
┌─────────────┐         UART            ┌─────────────┐
│   ESP32-C3  │◄───────────────────────►│    RP2040   │
│  (Wi-Fi AP) │  115200 baud            │ (Controller)│
└─────────────┘                         └─────────────┘
      │                                        │
      │                                        ├──► PWM GPIO2 ──► ESC (Throttle)
      │                                        ├──► PWM GPIO3 ──► Servo (Steering)
      │                                        ├──► GPIO4 ──► RC Receiver CH1 (Throttle)
      │                                        ├──► GPIO5 ──► RC Receiver CH2 (Steering)
      │                                        ├──► SPI GPIO6–9 ──► MPU-6050/MPU-6500 (IMU)
      │                                        │
      └──► Wi-Fi AP (для веб-интерфейса)
```

## Детальная схема подключений (legacy: ESP32-C3 + RP2040)

### 1. ESP32-C3

**Питание:**
- `5V` или `3V3` → от BEC 5V (через стабилизатор на плате) или 3.3V
- `GND` → общая земля

**UART к RP2040 (UART1 на ESP32-C3):**
- `GPIO4 (TX)` → `GPIO1 (RX)` на RP2040
- `GPIO5 (RX)` → `GPIO0 (TX)` на RP2040
- `GND` → общая земля

**Примечание:** ESP32-C3 питается от 3.3V; платы с USB часто имеют встроенный стабилизатор и питание от 5V.

### 2. Raspberry Pi Pico (RP2040)

**Питание:**
- `VSYS` или `VBUS` → 5V от BEC (через стабилизатор на плате Pico)
- `GND` → общая земля
- `3V3` → выход стабилизатора (для внешних компонентов)

**UART к ESP32-C3:**
- `GPIO0 (UART0 TX)` → `GPIO5 (RX)` на ESP32-C3
- `GPIO1 (UART0 RX)` → `GPIO4 (TX)` на ESP32-C3
- `GND` → общая земля

**PWM выходы (50 Hz, 1-2 мс):**
- `GPIO2 (PWM)` → Signal вход ESC (Throttle)
- `GPIO3 (PWM)` → Signal вход Servo (Steering)
- `GND` → общая земля с ESC/Servo

**RC-in входы (чтение PWM с приёмника):**
- `GPIO4` → Signal канал CH1 (Throttle) с RC приёмника
- `GPIO5` → Signal канал CH2 (Steering) с RC приёмника
- `GND` → общая земля с RC приёмником

**⚠️ ВАЖНО:** Если RC приёмник выдаёт 5V логику, используйте делители напряжения:
- Резистор 10kΩ между Signal и GPIO
- Резистор 20kΩ между GPIO и GND
- Или используйте level-shifter 5V→3.3V

**SPI к MPU-6050 / MPU-6500 (IMU)** — в прошивке используется **только SPI** (`firmware/common/mpu6050_spi.cpp`):

| RP2040       | MPU-6050/MPU-6500 | Надпись на плате   | Назначение        |
|--------------|-------------------|--------------------|-------------------|
| GPIO8 (CS)   | NCS / CS          | **NCS**            | Chip Select       |
| GPIO6 (SCK)  | SCLK              | **SCL / SCLK**     | Тактирование SPI  |
| GPIO7 (MOSI) | MOSI              | **SDA / SDI**      | Данные к датчику  |
| GPIO9 (MISO) | MISO              | **ADO / SDO**      | Данные от датчика |
| 3V3          | VCC               | **VCC**            | Питание 3.3 V     |
| GND          | GND               | **GND**            | Земля             |

Конфигурация пинов: `firmware/rp2040/main/config.hpp` (SPI_CS_PIN, SPI_SCK_PIN, SPI_MOSI_PIN, SPI_MISO_PIN).

### 3. MPU-6050 / MPU-6500 (IMU) — по SPI

В коде датчик подключён **по SPI** (драйвер `Mpu6050Spi`). I2C в прошивке не используется.

#### RP2040 (Pico)

| MPU-6050 / MPU-6500 | Надпись на плате   | RP2040    | Назначение        |
|--------------------|--------------------|-----------|-------------------|
| VCC                | **VCC**            | 3V3       | Питание 3.3 V     |
| GND                | **GND**            | GND       | Земля             |
| NCS / CS           | **NCS**            | GPIO8     | Chip Select       |
| SCLK               | **SCL / SCLK**     | GPIO6     | SPI SCK           |
| MOSI               | **SDA / SDI**      | GPIO7     | SPI MOSI          |
| MISO               | **ADO / SDO**      | GPIO9     | SPI MISO          |

#### STM32 (Blue Pill / Black Pill / G4)

| MPU-6050 / MPU-6500 | Надпись на плате   | STM32 (SPI2) | Назначение        |
|--------------------|--------------------|--------------|-------------------|
| VCC                | **VCC**            | 3V3          | Питание           |
| GND                | **GND**            | GND          | Земля             |
| NCS / CS           | **NCS**            | PB12         | Chip Select       |
| SCLK               | **SCL / SCLK**     | PB13 (SCK)   | Тактирование SPI  |
| MISO               | **ADO / SDO**      | PB14         | Данные от датчика |
| MOSI               | **SDA / SDI**      | PB15         | Данные к датчику  |

Пины STM32: `firmware/stm32/main/board_pins.hpp`.

#### Breakout «9250/9255/6500/6555» (одна колодка выводов)

У таких модулей подписи на плате **I2C/SPI в одном ряду**. Для **SPI** используйте соответствие:

| Надпись на плате | В режиме SPI | ESP32-S3 | ESP32-C6 | RP2040 | STM32 |
|------------------|--------------|----------|----------|--------|--------|
| VCC              | Питание      | 3V3      | 3V3      | 3V3    | 3V3    |
| GND              | Земля        | GND      | GND      | GND    | GND    |
| **SCL / SCLK**   | Такт SPI     | GPIO12   | GPIO6    | GPIO6  | PB13   |
| **SDA / SDI**    | MOSI (вход данных датчика) | GPIO11 | GPIO7 | GPIO7 | PB15   |
| EDA              | —            | н/п      | н/п      | н/п    | —      |
| ECL              | —            | н/п      | н/п      | н/п    | —      |
| **ADO / SDO**    | MISO (выход данных датчика) | GPIO13 | GPIO2 | GPIO9 | PB14   |
| INT              | Прерывание   | по желанию | по желанию | по желанию | —   |
| **NCS**          | Chip Select  | GPIO10   | GPIO10   | GPIO8  | PB12   |
| FSYNC            | Синхронизация| по желанию | по желанию | по желанию | —   |

- **SDI** = Serial Data Input = **MOSI** (контроллер шлёт, датчик принимает).  
- **SDO** = Serial Data Output = **MISO** (датчик шлёт, контроллер принимает).

Минимум для работы по SPI: **VCC, GND, SCL/SCLK, SDA/SDI, ADO/SDO, NCS**. Остальные выводы можно не подключать.

**Важно:**
- Питание **только 3.3 V** (2.4–3.6 V по даташиту). Не подавать 5 V на VCC (если на модуле есть свой стабилизатор — смотрите маркировку).
- **MPU-6500:** WHO_AM_I = **0x70** (в прошивке уже учтён вместе с 0x68).
- Частота SPI в конфиге: 1 MHz.

### 4. RC Приёмник (Himoto 2.4GHz 4CH)

**Подключение:**
- `CH1 (Signal)` → GPIO4 на RP2040 (через делитель, если 5V)
- `CH2 (Signal)` → GPIO5 на RP2040 (через делитель, если 5V)
- `+` → 5V от BEC (если требуется питание приёмника)
- `-` → GND

**Примечание:** RC приёмник обычно питается от BEC или батареи отдельно.

### 5. ESC (Electronic Speed Controller)

**Подключение:**
- `Signal` → GPIO2 (PWM) на RP2040
- `+` → 5V (обычно не используется, ESC питается от батареи)
- `-` → GND

**Примечание:** ESC питается напрямую от батареи (обычно 2S LiPo, 7.4V).

### 6. Servo (Рулевой сервопривод)

**Подключение:**
- `Signal` → GPIO3 (PWM) на RP2040
- `+` → 5V от BEC
- `-` → GND

### 7. Питание (BEC)

**Подключение:**
- `Input` → Батарея 2S LiPo (7.4V)
- `Output 5V` →
  - ESP32-C3 (5V — если плата с линейным стабилизатором)
  - RP2040 (VSYS/VBUS)
  - Servo (+)
  - RC приёмник (если требуется)
- `GND` → общая земля всех компонентов

**Конденсаторы для стабилизации:**
- 470-1000µF электролитический на шине 5V
- 0.1µF керамический параллельно

## Таблица подключений (краткая)

| Компонент | Контакт | RP2040/ESP32-C3 | Примечание |
|-----------|---------|-----------------|------------|
| ESP32-C3 | GPIO4 (TX) | RP2040 GPIO1 (RX) | UART |
| ESP32-C3 | GPIO5 (RX) | RP2040 GPIO0 (TX) | UART |
| ESC | Signal | RP2040 GPIO2 | PWM, 50Hz |
| Servo | Signal | RP2040 GPIO3 | PWM, 50Hz |
| RC RX | CH1 | RP2040 GPIO4 | Через делитель если 5V |
| RC RX | CH2 | RP2040 GPIO5 | Через делитель если 5V |
| MPU-6050/MPU-6500 | NCS | RP2040 GPIO8 | SPI CS |
| MPU-6050/MPU-6500 | SCK | RP2040 GPIO6 | SPI SCK |
| MPU-6050/MPU-6500 | MOSI | RP2040 GPIO7 | SPI MOSI |
| MPU-6050/MPU-6500 | MISO | RP2040 GPIO9 | SPI MISO |
| MPU-6050/MPU-6500 | VCC | RP2040 3V3 | Питание |
| Все | GND | Общая земля | ⚠️ Важно! |

## Делитель напряжения для RC-in (если нужно)

Если RC приёмник выдаёт 5V логику, а ESP32 / RP2040 работает на 3.3V:

```
RC Signal (5V) ──[10kΩ]──┬── GPIO RC-in (3.3V max)
                          │
                         [20kΩ]
                          │
                         GND
```

Формула: Vout = Vin × R2/(R1+R2) = 5V × 20k/(10k+20k) = 3.33V ✓

Применяется для **всех платформ** (ESP32-S3, ESP32-C6, RP2040) — все работают на 3.3V логике.

## Порядок подключения (рекомендуемый)

### Для ESP32-S3 / ESP32-C6 (standalone)

1. **Питание:**
   - Подключить BEC к батарее
   - Проверить выход 5V мультиметром
   - Подключить конденсаторы на шину 5V

2. **Микроконтроллер:**
   - Подключить ESP32 к 5V и GND (через USB-пин или 5V на плате)
   - Проверить, что плата работает (LED индикация, Serial Monitor)

3. **IMU:**
   - Подключить MPU-6500 по SPI (см. таблицу для соответствующей платы)
   - Подключить питание 3.3V от ESP32
   - Проверить инициализацию (WHO_AM_I: MPU-6500 = 0x70)

4. **RC приёмник:**
   - Подключить сигналы через делители (если 5V логика)
   - Подключить питание (если требуется)

5. **Исполнительные устройства:**
   - Подключить ESC к MCPWM GPIO (ESC)
   - Подключить Servo к MCPWM GPIO (Servo)
   - ⚠️ Безопасность: убедитесь, что failsafe работает перед тестами!

### Для ESP32-C3 + RP2040 (legacy)

1. **Питание:**
   - Подключить BEC к батарее
   - Проверить выход 5V мультиметром
   - Подключить конденсаторы на шину 5V

2. **Микроконтроллеры:**
   - Подключить ESP32-C3 к 3.3V/5V и GND (в зависимости от платы)
   - Подключить RP2040 к 5V и GND
   - Проверить, что оба работают (LED индикация)

3. **UART связь:**
   - Подключить TX→RX между ESP32 и RP2040
   - Подключить общую землю

4. **IMU:**
   - Подключить MPU-6050/MPU-6500 по SPI (RP2040: GPIO6–9; STM32: PB12–PB15)
   - Подключить питание 3.3V

5. **RC приёмник:**
   - Подключить сигналы через делители (если нужно)
   - Подключить питание (если требуется)

6. **Исполнительные устройства:**
   - Подключить ESC к GPIO2
   - Подключить Servo к GPIO3
   - ⚠️ Безопасность: убедитесь, что failsafe работает перед тестами!

## Проверка подключений

### Все платформы

1. **Питание:**
   - Проверить 5V на всех точках питания
   - Проверить 3.3V на ESP32 и MPU-6500

2. **SPI (IMU):**
   - Проверить инициализацию IMU (WHO_AM_I: MPU-6050 = 0x68, MPU-6500 = 0x70)

3. **PWM (MCPWM):**
   - Проверить осциллографом сигналы на MCPWM GPIO
   - Должны быть импульсы 1-2 мс, частота 50 Hz

4. **RC-in:**
   - Проверить сигналы с приёмника на RC-in GPIO

### Дополнительно для legacy (ESP32-C3 + RP2040)

5. **UART:**
   - Проверить связь между ESP32 и RP2040 (логи в Serial Monitor)

## Безопасность

⚠️ **ВАЖНО:**
- Всегда проверяйте failsafe перед первым запуском
- Убедитесь, что при потере связи ESC получает нейтральный сигнал
- Используйте предохранители на линиях питания
- Не подключайте/отключайте компоненты при включенном питании
- Проверяйте полярность батареи перед подключением

