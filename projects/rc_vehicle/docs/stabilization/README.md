# Система стабилизации RC-машины

Документация по системе стабилизации на базе ESP32-S3 с использованием IMU (MPU-6500).

## Содержание

- [Обзор](#обзор)
- [Архитектура](#архитектура)
- [Конфигурация](#конфигурация)
- [WebSocket API](#websocket-api)
- [Калибровка IMU](#калибровка-imu)
- [Примеры использования](#примеры-использования)
- [Troubleshooting](#troubleshooting)

## Обзор

Система стабилизации предназначена для:
- **Контроля рыскания (Yaw Rate Control)**: предотвращение неконтролируемых разворотов
- **Стабилизации на склонах (Pitch/Roll Compensation)**: компенсация наклона
- **Управления дрифтом (Drift Assist)**: поддержание заданного угла заноса

### Текущий статус (Phase 0)

✅ **Реализовано:**
- Чтение IMU на частоте 500 Гц (Core 1)
- Калибровка IMU (автоматическая и ручная)
- Фильтр Madgwick AHRS для оценки ориентации
- LPF Butterworth 2-го порядка для фильтрации gyro Z
- Конфигурация через WebSocket API
- Сохранение параметров в NVS

⏳ **В разработке:**
- ПИД-регулятор для контроля рыскания (Phase 1)
- Компенсация наклона (Phase 2)
- Управление дрифтом (Phase 3)

## Архитектура

### Компоненты

```
┌─────────────────────────────────────────────────────────────┐
│                     ESP32-S3 N16R8                          │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ Core 0: Wi-Fi, WebSocket, HTTP                       │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ Core 1: Control Loop (500 Hz)                        │   │
│  │  ├─ IMU Read (SPI, 500 Hz)                           │   │
│  │  ├─ Calibration (bias compensation)                  │   │
│  │  ├─ Madgwick AHRS (orientation estimation)           │   │
│  │  ├─ LPF Butterworth (gyro Z filtering)               │   │
│  │  ├─ PID Controller (yaw rate) [TODO]                 │   │
│  │  └─ PWM Output (ESC, Servo)                          │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
         │                                    │
         ▼                                    ▼
    MPU-6500 (SPI)                    ESC + Servo (PWM)
```

### Фильтрация данных

```
IMU (MPU-6500, SPI, 500 Гц)
    │
    ├──► Calibration (bias/offset compensation)
    │       │
    │       ├──► Madgwick AHRS ──► orientation (quat) ──► pitch, roll, yaw
    │       │
    │       └──► LPF Butterworth 2nd ──► filtered gyro_z
    │
    └──► Raw data (для диагностики)
```

## Конфигурация

### Структура конфигурации

```cpp
struct StabilizationConfig {
  bool enabled;              // Включена ли стабилизация
  float madgwick_beta;       // Коэффициент Madgwick (0.01-1.0)
  float lpf_cutoff_hz;       // Частота среза LPF (5-100 Hz)
  float imu_sample_rate_hz;  // Частота дискретизации IMU (500 Hz)
  uint8_t mode;              // Режим: 0=normal, 1=sport, 2=drift
};
```

### Параметры

#### `enabled` (bool)
- **По умолчанию**: `false`
- **Описание**: Главный переключатель системы стабилизации
- **Примечание**: В Phase 0 влияет только на конфигурацию

#### `madgwick_beta` (float)
- **Диапазон**: 0.01 - 1.0
- **По умолчанию**: 0.1
- **Описание**: Коэффициент усиления фильтра Madgwick
- **Эффект**:
  - Больше → быстрее реакция на акселерометр, больше шум
  - Меньше → медленнее реакция, стабильнее ориентация
- **Рекомендация**: Начните с 0.1, корректируйте по уровню вибраций

#### `lpf_cutoff_hz` (float)
- **Диапазон**: 5.0 - 100.0 Hz
- **По умолчанию**: 30.0 Hz
- **Описание**: Частота среза LPF Butterworth для gyro Z
- **Эффект**:
  - Меньше → сильнее фильтрация, меньше шум, больше задержка
  - Больше → слабее фильтрация, быстрее отклик, больше шум
- **Рекомендация**: 20-40 Hz для типичных RC-машин

#### `mode` (uint8_t)
- **Значения**: 0 (normal), 1 (sport), 2 (drift)
- **По умолчанию**: 0
- **Описание**: Режим стабилизации
- **Примечание**: Специфичное поведение режимов пока не реализовано

### Хранение конфигурации

Конфигурация сохраняется в энергонезависимой памяти (NVS) ESP32:
- **Namespace**: `"stab_cfg"`
- **Key**: `"config"`
- Автоматически загружается при старте
- Переживает перезагрузки и отключения питания

## WebSocket API

### Подключение

```
ws://192.168.4.1/ws
```

### Получение конфигурации

**Запрос:**
```json
{
  "type": "get_stab_config"
}
```

**Ответ:**
```json
{
  "type": "stab_config",
  "enabled": false,
  "madgwick_beta": 0.1,
  "lpf_cutoff_hz": 30.0,
  "imu_sample_rate_hz": 500.0,
  "mode": 0
}
```

### Установка конфигурации

**Запрос:**
```json
{
  "type": "set_stab_config",
  "enabled": true,
  "madgwick_beta": 0.15,
  "lpf_cutoff_hz": 25.0
}
```

**Ответ:**
```json
{
  "type": "set_stab_config_ack",
  "ok": true,
  "enabled": true,
  "madgwick_beta": 0.15,
  "lpf_cutoff_hz": 25.0,
  "mode": 0
}
```

**Примечания:**
- Параметры опциональны — обновляются только указанные поля
- Значения автоматически ограничиваются допустимым диапазоном
- Конфигурация сохраняется в NVS при `ok: true`

## Калибровка IMU

### Двухэтапная калибровка

#### Этап 1: Стояние на месте
Определяет bias гироскопа и акселерометра, вектор гравитации.

**Автоматически при старте** (если машина неподвижна):
```
Запускается автоматически, 1000 семплов
```

**Ручной запуск:**
```json
{
  "type": "calibrate_imu",
  "mode": "full"
}
```

**Ответ:**
```json
{
  "type": "calibrate_imu_ack",
  "status": "collecting",
  "stage": 1,
  "ok": true,
  "mode": "full"
}
```

#### Этап 2: Движение вперёд/назад
Определяет вектор направления движения.

**Процедура:**
1. Завершите этап 1
2. Поставьте колёса прямо
3. Запустите калибровку:
```json
{
  "type": "calibrate_imu",
  "mode": "forward"
}
```
4. Двигайте машину вперёд и назад по прямой (2-3 секунды)

**Ответ:**
```json
{
  "type": "calibrate_imu_ack",
  "status": "collecting",
  "stage": 2,
  "ok": true
}
```

### Проверка статуса калибровки

**Запрос:**
```json
{
  "type": "get_calib_status"
}
```

**Ответ:**
```json
{
  "type": "calib_status",
  "status": "done",
  "stage": 2
}
```

**Статусы:**
- `"idle"` — калибровка не запущена
- `"collecting"` — сбор данных
- `"done"` — завершена успешно
- `"failed"` — ошибка

### Ручная установка направления

Если этап 2 не выполнялся, можно задать вектор вручную:

```json
{
  "type": "set_forward_direction",
  "vec": [1.0, 0.0, 0.0]
}
```

## Примеры использования

### Python

```python
import websocket
import json
import time

# Подключение
ws = websocket.create_connection("ws://192.168.4.1/ws")

# Получить текущую конфигурацию
ws.send(json.dumps({"type": "get_stab_config"}))
config = json.loads(ws.recv())
print(f"Текущая конфигурация: {config}")

# Включить стабилизацию с настройками
ws.send(json.dumps({
    "type": "set_stab_config",
    "enabled": True,
    "madgwick_beta": 0.12,
    "lpf_cutoff_hz": 35.0
}))
ack = json.loads(ws.recv())
print(f"Конфигурация обновлена: {ack['ok']}")

# Запустить калибровку
ws.send(json.dumps({
    "type": "calibrate_imu",
    "mode": "full"
}))
response = json.loads(ws.recv())
print(f"Калибровка запущена: {response}")

# Подождать завершения
time.sleep(5)

# Проверить статус
ws.send(json.dumps({"type": "get_calib_status"}))
status = json.loads(ws.recv())
print(f"Статус калибровки: {status}")

ws.close()
```

### JavaScript (Browser)

```javascript
const ws = new WebSocket('ws://192.168.4.1/ws');

ws.onopen = () => {
  console.log('Connected');

  // Получить конфигурацию
  ws.send(JSON.stringify({type: 'get_stab_config'}));
};

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log('Received:', data);

  if (data.type === 'stab_config') {
    console.log('Current config:', data);

    // Обновить параметры
    ws.send(JSON.stringify({
      type: 'set_stab_config',
      enabled: true,
      madgwick_beta: 0.15,
      lpf_cutoff_hz: 30.0
    }));
  }

  if (data.type === 'set_stab_config_ack') {
    console.log('Config updated:', data.ok);
  }
};

ws.onerror = (error) => {
  console.error('WebSocket error:', error);
};
```

### curl (для тестирования)

```bash
# Получить конфигурацию (через websocat)
echo '{"type":"get_stab_config"}' | websocat ws://192.168.4.1/ws

# Установить конфигурацию
echo '{"type":"set_stab_config","enabled":true,"madgwick_beta":0.15}' | \
  websocat ws://192.168.4.1/ws
```

## Troubleshooting

### Проблема: Ориентация дрейфует

**Причины:**
- Недостаточная калибровка гироскопа
- Слишком большой `madgwick_beta`
- Вибрации от моторов

**Решение:**
1. Выполните полную калибровку (этап 1 + 2)
2. Уменьшите `madgwick_beta` до 0.05-0.08
3. Проверьте крепление IMU (виброизоляция)

### Проблема: Медленная реакция на повороты

**Причины:**
- Слишком маленький `madgwick_beta`
- Слишком низкая частота среза LPF

**Решение:**
1. Увеличьте `madgwick_beta` до 0.12-0.15
2. Увеличьте `lpf_cutoff_hz` до 40-50 Hz

### Проблема: Шумные данные gyro Z

**Причины:**
- Слишком высокая частота среза LPF
- Вибрации

**Решение:**
1. Уменьшите `lpf_cutoff_hz` до 20-25 Hz
2. Улучшите виброизоляцию IMU
3. Проверьте балансировку колёс

### Проблема: Конфигурация не сохраняется

**Причины:**
- Ошибка записи в NVS
- Невалидные параметры

**Решение:**
1. Проверьте логи ESP32 (UART)
2. Убедитесь, что параметры в допустимом диапазоне
3. Попробуйте стереть NVS и переустановить конфигурацию

### Проблема: Калибровка не завершается

**Причины:**
- Машина движется во время калибровки
- Недостаточно семплов

**Решение:**
1. Убедитесь, что машина полностью неподвижна
2. Поставьте на ровную поверхность
3. Подождите 5-10 секунд
4. Проверьте статус через `get_calib_status`

## Дополнительные ресурсы

- [Физика стабилизации](physics.md) — подробное описание физических моделей, математики фильтров, PID, EKF, модели шин
- [Роудмап стабилизации](roadmap_ru.md) — план разработки
- [Реализация конфигурации](../../firmware/STABILIZATION_CONFIG_IMPLEMENTATION.md) — технические детали
- [Madgwick Filter](../../firmware/common/madgwick_filter.hpp) — исходный код фильтра
- [LPF Butterworth](../../firmware/common/lpf_butterworth.hpp) — исходный код LPF

## Контакты и поддержка

При возникновении проблем:
1. Проверьте логи ESP32 через UART (115200 baud)
2. Изучите телеметрию через WebSocket
3. Создайте issue в репозитории проекта

---

**Версия документации**: 1.0
**Дата обновления**: 2026-02-19
**Статус**: Phase 0 (конфигурация реализована, стабилизация в разработке)
