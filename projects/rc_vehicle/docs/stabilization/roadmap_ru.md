# Роудмап системы стабилизации

Роудмап разработки системы стабилизации для RC-машины на базе **ESP32-S3 N16R8** с использованием IMU.

## Платформа

Вся система реализуется на **одной отладочной плате ESP32-S3 N16R8**:

| Параметр | Значение |
|----------|----------|
| MCU | ESP32-S3 (Dual Xtensa LX7 @ 240 МГц) |
| FPU | Есть (single precision) |
| SRAM | 512 КБ |
| Flash | 16 МБ |
| PSRAM | 8 МБ |
| Wi-Fi | Встроен (802.11 b/g/n) |
| MCPWM | Аппаратный модуль управления моторами |
| RTOS | FreeRTOS (ESP-IDF) |

**Преимущества единой платформы:**
- Нет UART-моста между контроллерами — минимальная задержка от WebSocket до PWM
- Два ядра: **Core 0** — Wi-Fi/WebSocket, **Core 1** — control loop (IMU + фильтрация + ПИД + PWM)
- FPU позволяет использовать float-математику без оверхеда (Madgwick, EKF)
- 8 МБ PSRAM — достаточно для буферов телеметрии, логов и истории данных

## Цели системы стабилизации

- **Контроль рыскания (Yaw Rate Control)**: предотвращение неконтролируемых разворотов и заносов
- **Стабилизация на склонах (Pitch/Roll Compensation)**: компенсация наклона при движении по неровной поверхности
- **Управление дрифтом (Drift Assist)**: поддержание заданного угла заноса в повороте, упрощение контроля при движении в управляемом скольжении
- **Плавность управления**: фильтрация резких команд и вибраций

## Фазы разработки

### Фаза 0: Подготовка и анализ (MVP+)

**Цель**: Подготовить инфраструктуру для стабилизации, не нарушая базовую функциональность.

**Задачи**:
- [x] Обеспечить стабильное чтение IMU (MPU-6500, SPI) на частоте ≥500 Гц на Core 1
- [x] Реализовать калибровку IMU:
  - [x] Ручная калибровка: сбор offset/bias гироскопа и акселерометра в покое по команде оператора
  - [x] Автоматическая калибровка гироскопа при старте (auto-zero bias при неподвижности)
  - [x] Автоматическая калибровка акселерометра (компенсация offset по среднему значению g-вектора)
  - [x] Сохранение калибровочных данных в NVS (переживают перезагрузку)
  - [x] Валидация калибровки: детекция устаревших/невалидных данных (температурный дрейф, замена датчика)
  - [x] WebSocket API: запуск калибровки, просмотр статуса и текущих значений
- [x] Реализовать фильтр Madgwick (AHRS) для оценки ориентации (кватернион → pitch/roll/yaw)
- [x] Реализовать LPF Butterworth 2-го порядка для фильтрации gyro Z (подготовка к yaw rate PID)
- [x] Добавить конфигурационные параметры стабилизации (через WebSocket API)
- [x] Создать режим "стабилизация выключена" (прямая передача команд)
- [x] Добавить данные фильтрации в телеметрию (ориентация, фильтрованный gyro, статус калибровки)
- [x] Организовать control loop на Core 1 (высокоприоритетный таск FreeRTOS, период 2 мс)

**Архитектура фильтрации**:
```
IMU (MPU-6500, SPI, 500 Гц)
    │
    ├──► Calibration (bias/offset compensation)
    │       │
    │       ├──► Madgwick AHRS ──► orientation (quat) ──► pitch, roll, yaw
    │       │
    │       └──► LPF (Butterworth 2nd order) ──► filtered gyro_z
    │
    └──► Raw data (для диагностики и перекалибровки)
```

**Калибровка IMU (два этапа)**:
- **Этап 1 — стояние на месте**: по команде или при старте (если неподвижна). Сбор семплов в покое → gyro bias, accel bias, **вектор g в СК датчика** (`gravity_vec`). Сохраняется в NVS. WebSocket: `calibrate_imu` с `mode: "full"`.
- **Этап 2 — движение вперёд/назад**: по команде после этапа 1. Оператор едет вперёд и назад с прямыми колёсами; по линейному ускорению (accel − gravity_vec) определяется единичный вектор «вперёд» (`forward_vec`). WebSocket: `calibrate_imu` с `mode: "forward"`. В телеметрии: `calib.stage` (1 или 2), `calib.gravity_vec`, `calib.forward_vec`, `imu.forward_accel`.
- **При старте (автоматически)**: если машина неподвижна — этап 1 (bias + gravity_vec). Если motion detected — загрузка из NVS.
- **Ручная установка вектора «вперёд»**: `set_forward_direction` с `"vec":[fx,fy,fz]` (если этап 2 не выполнялся).
- **Runtime drift compensation**: периодическая коррекция gyro bias при обнаружении неподвижности (zero-rate update, ZUPT)
- **Температурная компенсация** (опционально): таблица bias vs temperature, строится при калибровке в разных температурных условиях

**Критерии готовности**:
- [x] IMU читается стабильно на 500 Гц без пропусков на Core 1
- [x] Калибровка гироскопа и акселерометра выполняется автоматически при старте (если машина неподвижна)
- [x] Двухэтапная калибровка: этап 1 (покой → bias + gravity_vec), этап 2 (движение вперёд/назад → forward_vec); оба сохраняются в NVS
- [x] Ручная калибровка запускается через WebSocket API и завершается за <5 секунд
- [x] Калибровочные данные сохраняются в NVS и корректно восстанавливаются при перезагрузке
- [ ] Madgwick даёт стабильную ориентацию (pitch/roll без дрейфа) на откалиброванных данных
- [x] Данные фильтрации и статус калибровки доступны в телеметрии через WebSocket (ориентация pitch/roll/yaw, статус калибровки, bias, gravity_vec, forward_vec, gyro_z_filtered)
- [x] Режим стабилизации можно включать/выключать через WebSocket API
- [x] Без стабилизации система работает как раньше
- [x] Control loop на Core 1 не влияет на работу Wi-Fi/WebSocket на Core 0

**Оценка**: 1-2 недели

---

### Фаза 1: Базовый контроль рыскания (Yaw Rate Assist)

**Цель**: Предотвращение неконтролируемых разворотов при резких манёврах.

**Задачи**:
- [ ] Реализовать ПИД-регулятор для контроля угловой скорости по оси Z (yaw rate)
- [ ] Добавить настройки ПИД (Kp, Ki, Kd) через конфигурацию
- [ ] Интегрировать коррекцию руля на основе ошибки yaw rate
- [ ] Добавить ограничение максимальной коррекции (safety limit)
- [ ] Реализовать плавное включение/выключение стабилизации

**Технические детали**:
- Целевая частота регулятора: 500 Гц (период 2 мс, совмещён с control loop на Core 1)
- Источник данных: фильтрованный gyro Z (LPF Butterworth 2-го порядка из Фазы 0)
- Выход: коррекция команды руля (steer correction)
- Формула: `steer_corrected = steer_command + PID(yaw_rate_error)`
- Настройки ПИД передаются через WebSocket API, хранятся в NVS

**Критерии готовности**:
- При резком повороте система компенсирует избыточное вращение
- Настройки ПИД можно менять через WebSocket без перепрошивки
- Параметры сохраняются в NVS и восстанавливаются при перезагрузке
- Стабилизация не мешает нормальному управлению
- Тесты на ровной поверхности показывают улучшение стабильности

**Оценка**: 2-3 недели

---

### Фаза 2: Стабилизация на склонах (Pitch/Roll Compensation)

**Цель**: Компенсация наклона при движении по неровной поверхности.

**Задачи**:
- [ ] Использовать акселерометр для определения наклона (pitch/roll)
- [ ] Реализовать фильтрацию наклона (убрать влияние ускорения от движения)
- [ ] Добавить коррекцию газа при движении вверх/вниз по склону
- [ ] Добавить коррекцию руля при боковом наклоне (опционально)

**Технические детали**:
- Источник: pitch/roll из фильтра Madgwick (реализован в Фазе 0)
- Компенсация: коррекция базовой команды газа на основе pitch
- Ограничение: максимальная коррекция не более 20-30% от команды
- Дополнительная фильтрация не требуется — Madgwick уже даёт стабильную ориентацию

**Критерии готовности**:
- При движении вверх по склону газ автоматически увеличивается
- При движении вниз газ уменьшается
- Система не мешает нормальному управлению на ровной поверхности

**Оценка**: 2-3 недели

---

### Фаза 3: Управление дрифтом (Drift Assist)

**Цель**: Поддержание заданного угла заноса в повороте, упрощение управления в скольжении.

**Задачи**:
- [ ] Реализовать оценку угла заноса (slip angle) через EKF (Extended Kalman Filter)
- [ ] Интегрировать данные IMU (Madgwick orientation + gyro_z) в EKF
- [ ] Реализовать bicycle model для предсказания динамики автомобиля
- [ ] Добавить ПИД/контроллер для поддержания целевого slip angle
- [ ] Реализовать режим "drift mode" — стабилизация удерживает заданный угол заноса вместо подавления
- [ ] Добавить плавный переход между обычным режимом и drift mode

**Технические детали**:
- EKF state vector: `[vx, vy, yaw_rate, slip_angle]` (4-state, IMU-only)
- Входы: Madgwick orientation + gyro_z + accel (для оценки скорости)
- На ESP32-S3 с FPU: ~10-30 мкс на итерацию EKF — без проблем на 500 Гц
- Целевой slip angle задаётся оператором или вычисляется из команды руля
- Выход: коррекция газа и руля для поддержания заноса
- *Примечание*: при добавлении датчиков скорости колёс в будущем EKF можно расширить для более точной оценки

**Критерии готовности**:
- Система корректно оценивает slip angle в реальном времени (на основе IMU)
- В drift mode машина удерживает заданный угол заноса
- Переход между обычным режимом и drift mode плавный, без рывков
- Параметры настраиваются через WebSocket API

**Оценка**: 4-6 недель

---

### Фаза 4: Продвинутые алгоритмы

**Цель**: Улучшение качества стабилизации и добавление новых возможностей.

**Задачи**:
- [ ] Адаптивные ПИД-параметры (изменение в зависимости от скорости/режима)
- [ ] Предсказание поведения (простые модели для предупреждения заноса)
- [ ] Режимы стабилизации (спорт/обычный/дрифт)
- [ ] Логирование данных в PSRAM для анализа и настройки
- [ ] Интеграция с веб-интерфейсом для настройки параметров и просмотра графиков в реальном времени

**Критерии готовности**:
- Пользователь может выбирать режимы стабилизации
- Параметры можно настраивать через веб-интерфейс
- Система адаптируется к условиям движения
- Логи доступны для скачивания и анализа

**Оценка**: 4-6 недель

---

## Технические требования

### Аппаратные требования

- ESP32-S3 N16R8 (отладочная плата) — единственный контроллер
- IMU (MPU-6500) — подключение по SPI
- Стабильное питание 3.3V для IMU

### Программные требования

- RTOS: FreeRTOS (ESP-IDF)
- Частота чтения IMU: 500 Гц
- Частота обновления регуляторов: 500 Гц
- Задержка от WebSocket-команды до коррекции PWM: <5 мс (нет UART-моста)
- Фильтрация: Madgwick AHRS (ориентация) + LPF Butterworth 2-го порядка (gyro)
- Control loop: Core 1, высокоприоритетный таск, период 2 мс
- Wi-Fi/WebSocket: Core 0
- Хранение параметров: NVS (энергонезависимая память ESP32)
- Буферы и логи: PSRAM (8 МБ)

### Распределение по ядрам

| Core | Задачи | Приоритет |
|------|--------|-----------|
| **Core 0** | Wi-Fi, WebSocket, HTTP, веб-интерфейс | Стандартный (ESP-IDF default) |
| **Core 1** | IMU чтение (SPI), Madgwick, LPF, PID, PWM вывод | Высокий (configMAX_PRIORITIES - 1) |

### Интерфейсы

**WebSocket API** (единый интерфейс, без UART-моста):
- Команды управления: throttle, steering (как раньше)
- Включение/выключение стабилизации
- Настройка параметров ПИД (Kp, Ki, Kd) и фильтрации (beta Madgwick, cutoff LPF)
- Выбор режима: normal / sport / drift
- Телеметрия стабилизации: ориентация, gyro filtered, PID error/output, статус калибровки

**Хранение конфигурации (NVS)**:
- Параметры ПИД для каждого регулятора
- Параметры фильтрации (beta, cutoff frequency)
- Текущий режим стабилизации
- Safety limits

## Интеграция с существующей системой

### Структура модулей (ESP32-S3, ESP-IDF)

**Язык**: C++23 (C++26 при доступности в toolchain). ESP-IDF собирается через CMake с флагом `-std=c++23`.

**Новые компоненты** (components/):
- `stabilization/` — основная логика стабилизации
  - `madgwick_filter.hpp/cpp` — фильтр Madgwick AHRS (кватернионная ориентация)
  - `lpf_butterworth.hpp/cpp` — LPF Butterworth 2-го порядка (фильтрация gyro)
  - `pid_controller.hpp/cpp` — универсальный ПИД-регулятор
  - `yaw_rate_control.hpp/cpp` — контроль рыскания
  - `drift_assist.hpp/cpp` — управление дрифтом (EKF + slip angle)
  - `stabilization_manager.hpp/cpp` — менеджер режимов и координация
- `calibration/` — калибровка датчиков
  - `imu_calibration.hpp/cpp` — калибровка IMU (gyro bias, accel offset/scale, auto-zero, ZUPT)
  - `calibration_storage.hpp/cpp` — сохранение/загрузка/валидация калибровочных данных (NVS)
- `imu_driver/` — драйвер MPU-6500 (SPI, 500 Гц, Core 1)

**Изменения в существующих модулях**:
- `pwm_control` — применение коррекций от стабилизации (MCPWM)
- `websocket_server` — расширение API: команды стабилизации, телеметрия, настройка параметров
- `web_ui` — панель настройки стабилизации, графики в реальном времени
- `nvs_config` — сохранение/загрузка параметров стабилизации

### Потоки данных (единая плата)

```
[WebSocket API]  ──►  cmd queue  ──►  [Control Loop, Core 1]  ──►  [MCPWM]
     (Core 0)          (FreeRTOS)       │  IMU (SPI, 500 Гц)       ESC/Servo
                                        │  Madgwick → orientation
                                        │  LPF → filtered gyro_z
                                        │  PID → steer/throttle correction
                                        │
                                        └──►  telem queue  ──►  [WebSocket Telemetry]
                                              (FreeRTOS)          (Core 0, 20-50 Гц)
```

## Тестирование и валидация

### Фаза 1 (Yaw Rate Control)
- [ ] Тест на ровной поверхности: резкий поворот без стабилизации vs с стабилизацией
- [ ] Тест на скользкой поверхности: контроль заноса
- [ ] Тест безопасности: отключение стабилизации не должно вызывать рывков

### Фаза 2 (Pitch/Roll Compensation)
- [ ] Тест на склоне: движение вверх/вниз
- [ ] Тест на неровной поверхности: компенсация бокового наклона

### Фаза 3 (Drift Assist)
- [ ] Тест оценки slip angle: сравнение с визуальным наблюдением
- [ ] Тест drift mode: удержание заданного угла заноса в повороте
- [ ] Тест перехода: плавное переключение normal ↔ drift mode
- [ ] Тест совместной работы с yaw rate control

### Общие тесты
- [ ] Производительность: задержки не превышают требования
- [ ] Надёжность: система работает стабильно при длительной работе
- [ ] Failsafe: при сбое стабилизации система переходит в безопасный режим

## Риски и ограничения

### Технические риски
- **Вибрации**: IMU может давать шумные данные из-за вибраций шасси
  - *Митигация*: Madgwick + LPF Butterworth, жёсткое крепление IMU, возможна механическая виброизоляция
- **Wi-Fi и control loop на одном чипе**: сетевой стек может создавать jitter
  - *Митигация*: строгое разделение по ядрам (Core 0 — Wi-Fi, Core 1 — control loop), высокий приоритет таска на Core 1
- **SPI-шина**: IMU на 500 Гц по SPI может конфликтовать с другими SPI-устройствами
  - *Митигация*: выделенная SPI-шина для IMU (ESP32-S3 имеет несколько SPI контроллеров)
- **Yaw drift без магнитометра**: Madgwick без магнитометра не может корректировать yaw drift
  - *Митигация*: для yaw rate control дрейф не критичен (используется угловая скорость, а не абсолютный угол); для drift assist — EKF с bicycle model компенсирует через динамическую модель

### Ограничения
- Стабилизация не заменяет хорошую механику (подвеска, шины)
- На очень высоких скоростях эффективность может снижаться
- Требуется настройка параметров под конкретную машину и условия
- Без магнитометра абсолютный yaw (heading) будет дрейфовать — это приемлемо для текущих задач

## Приоритизация

**Высокий приоритет** (MVP+):
- Фаза 0: Подготовка, калибровка и фильтрация (Madgwick + LPF)
- Фаза 1: Yaw Rate Control

**Средний приоритет**:
- Фаза 2: Pitch/Roll Compensation
- Фаза 3: Drift Assist (IMU-only EKF)

**Низкий приоритет** (nice to have):
- Фаза 4: Продвинутые алгоритмы

## Ссылки на документацию

- Основное ТЗ: `docs/ts.md`
- Протоколы: `docs/interfaces_protocols.md`
- Тайминги: `docs/firmware_timing.md`
- Стиль кода: `docs/cpp_coding_style.md`
- Глоссарий: `docs/glossary_ru.md`

## История изменений

- **2026-02-17**: Отмечены выполненные пункты Фазы 0: чтение IMU 500 Гц на Core 1, калибровка (ручная + авто гиро при старте), NVS, валидация, WebSocket API калибровки, режим «стабилизация выключена», control loop Core 1; критерии готовности обновлены
- **2025-02-12**: Переход на единую платформу ESP32-S3 N16R8; обновлена архитектура фильтрации (Madgwick + LPF Butterworth); добавлены калибровка IMU и Drift Assist (IMU-only EKF); убраны датчики скорости из текущего плана; обновлены технические требования и структура модулей
- **2024-XX-XX**: Создан первоначальный роудмап
